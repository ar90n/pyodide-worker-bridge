// generated by pyodide-bridge (DO NOT EDIT)

import * as Comlink from "comlink";
import { bootstrapPyodide, deepConvertMaps, detectBridgeError } from "pyodide-bridge/runtime";

import pythonSource from "./engine.py?raw";

import type { AnalysisParams, AnalysisResult } from "./engine.types.js";

export interface BridgeAPI {
  analyze(params: AnalysisParams): Promise<AnalysisResult>;
}

let pyodide: Awaited<ReturnType<typeof bootstrapPyodide>>;

async function init(): Promise<void> {
  pyodide = await bootstrapPyodide({
    pyodideVersion: "0.27.5",
    packages: [],
    pythonSource,
  });
}

const api: BridgeAPI = {
  async analyze(params: AnalysisParams): Promise<AnalysisResult> {
    const globals = pyodide.globals;
    const pyFunc = globals.get("analyze");
    const pyResult = pyFunc(pyodide.toPy(params));
    const jsResult = deepConvertMaps<AnalysisResult>(pyResult.toJs());
    detectBridgeError(jsResult);
    return jsResult;
  }
};

init().then(() => {
  Comlink.expose(api);
});
